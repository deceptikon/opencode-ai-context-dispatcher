#!/usr/bin/env zsh
# ctx - OpenCode Context Dispatcher (Full Shell Version)

# Resolve the real path of the script to handle symlinks
SOURCE="${(%):-%N}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
DISPATCHER_PATH="$SCRIPT_DIR/../context-dispatcher.zsh"

# Fallback for when running from repo or unconventional install
if [[ ! -f "$DISPATCHER_PATH" ]]; then
    DISPATCHER_PATH="$SCRIPT_DIR/context-dispatcher.zsh"
fi

if [[ -f "$DISPATCHER_PATH" ]]; then
    source "$DISPATCHER_PATH"
    
    # Handle semantic search/sync via extensions if requested
    # Check both potential extension locations (installed vs repo)
    EXT_BIN="$SCRIPT_DIR/../extensions/ctx-vector"
    [[ ! -x "$EXT_BIN" ]] && EXT_BIN="$SCRIPT_DIR/extensions/ctx-vector"

    case "$1" in
        semantic-search|search-v)
            shift
            if [[ -x "$EXT_BIN" ]]; then
                exec "$EXT_BIN" search "$@"
            else
                echo "Error: Semantic search extension not found."
                exit 1
            fi
            ;;
        sync-v)
            shift
            if [[ -x "$EXT_BIN" ]]; then
                exec "$EXT_BIN" index "$@"
            else
                echo "Error: Semantic sync extension not found."
                exit 1
            fi
            ;;
    esac

    context "$@"
    
    # Post-process: sync vector store after reindex or update if extension available
    if [[ "$1" == "reindex" || "$1" == "update" ]]; then
        if [[ -x "$EXT_BIN" ]]; then
            echo "ðŸ”„ Syncing semantic index..."
            "$EXT_BIN" index "$2" >/dev/null 2>&1 &
        fi
    fi
else
    # Fallback to python version if dispatcher not found
    if [[ -f "$SCRIPT_DIR/ctx.py" ]]; then
        python3 "$SCRIPT_DIR/ctx.py" "$@"
    else
        echo "Error: Context dispatcher not found at $DISPATCHER_PATH (resolved from $SOURCE)"
        exit 1
    fi
fi
